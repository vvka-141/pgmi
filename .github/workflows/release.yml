name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Cloudsmith CLI
        run: pip install cloudsmith-cli

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}

  chocolatey:
    name: Publish to Chocolatey
    needs: release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Download Windows binary
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $url = "https://github.com/vvka-141/pgmi/releases/download/${{ github.ref_name }}/pgmi_${version}_windows_amd64.zip"
          Write-Host "Downloading from: $url"
          New-Item -ItemType Directory -Force -Path choco/tools
          Invoke-WebRequest -Uri $url -OutFile pgmi.zip
          Expand-Archive pgmi.zip -DestinationPath choco/tools -Force

      - name: Create nuspec
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          @"
          <?xml version="1.0"?>
          <package xmlns="http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd">
            <metadata>
              <id>pgmi</id>
              <version>$version</version>
              <title>pgmi</title>
              <authors>Alexey Evlampiev</authors>
              <owners>vvka-141</owners>
              <projectUrl>https://github.com/vvka-141/pgmi</projectUrl>
              <licenseUrl>https://github.com/vvka-141/pgmi/blob/main/LICENSE</licenseUrl>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <description>pgmi is a PostgreSQL-native execution fabric and deployment tool. It uses a session-centric approach: loads SQL files and runtime parameters into PostgreSQL session-scoped temporary tables, then hands control to a user-provided deploy.sql script.</description>
              <summary>PostgreSQL-native execution fabric for humans and autonomous agents</summary>
              <tags>postgresql database deployment cli devops migration sql</tags>
              <releaseNotes>https://github.com/vvka-141/pgmi/releases/tag/${{ github.ref_name }}</releaseNotes>
            </metadata>
            <files>
              <file src="tools\**" target="tools" />
            </files>
          </package>
          "@ | Out-File -FilePath choco/pgmi.nuspec -Encoding UTF8

      - name: Create install script
        shell: pwsh
        run: |
          @'
          $toolsDir = "$(Split-Path -parent $MyInvocation.MyCommand.Definition)"
          $exePath = Join-Path $toolsDir 'pgmi.exe'
          Install-BinFile -Name 'pgmi' -Path $exePath
          '@ | Out-File -FilePath choco/tools/chocolateyInstall.ps1 -Encoding UTF8

      - name: Create uninstall script
        shell: pwsh
        run: |
          @'
          Uninstall-BinFile -Name 'pgmi'
          '@ | Out-File -FilePath choco/tools/chocolateyUninstall.ps1 -Encoding UTF8

      - name: Pack and push
        shell: pwsh
        run: |
          cd choco
          choco pack pgmi.nuspec
          choco push pgmi.${{ steps.version.outputs.VERSION }}.nupkg --source https://push.chocolatey.org/ --api-key ${{ secrets.CHOCOLATEY_API_KEY }}
